#!/bin/bash

# TiLoKit Commit Message Validator
# Ensures all commit messages follow conventional commit format

# ANSI color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Valid conventional commit types (from pr-auto-label.yml)
VALID_TYPES=(
    "feat"      # âœ¨ Enhancement
    "fix"       # ğŸ› Bug
    "docs"      # ğŸ“š Documentation
    "refactor"  # â™»ï¸ Refactor
    "perf"      # âš¡ Performance
    "test"      # ğŸ§ª Test
    "build"     # ğŸ› ï¸ Build
    "ci"        # ğŸ”„ CI/CD
    "chore"     # ğŸ§¹ Maintenance
    "style"     # ğŸ¨ Style
    "revert"    # âª Revert
)

# Read commit message from file
COMMIT_MSG_FILE=$1
COMMIT_MSG=$(head -n1 "$COMMIT_MSG_FILE")

echo -e "${BLUE}ğŸ” Validating commit message:${NC} ${COMMIT_MSG}"

# Skip validation for merge commits
if [[ $COMMIT_MSG =~ ^Merge\ .*|^Revert\ .* ]]; then
    echo -e "${GREEN}âœ… Merge/Revert commit detected - skipping validation${NC}"
    exit 0
fi

# Check strict conventional commit format: type: description (NO scopes allowed)
# Must be: type: description with exactly one space after colon
# Must not have leading/trailing whitespace
COMMIT_PATTERN='^[a-z]+: .+'

# Check for leading/trailing whitespace
if [[ "$COMMIT_MSG" != "$(echo "$COMMIT_MSG" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')" ]]; then
    echo -e "${RED}âŒ Commit message has leading or trailing whitespace!${NC}"
    echo -e "${YELLOW}ğŸ“‹ Example of invalid:${NC} ${RED}' fix: something'${NC} or ${RED}'fix: something '${NC}"
    echo -e "${YELLOW}ğŸ“‹ Example of valid:${NC} ${GREEN}'fix: something'${NC}"
    exit 1
fi

# Check for scope usage (not allowed)
if echo "$COMMIT_MSG" | grep -qE '^[a-z]+\([^)]+\):'; then
    echo -e "${RED}âŒ Scopes are not allowed in commit messages!${NC}"
    echo -e "${YELLOW}ğŸ“‹ Invalid:${NC} ${RED}feat(ci): something${NC}"
    echo -e "${YELLOW}ğŸ“‹ Valid:${NC} ${GREEN}ci: something${NC}"
    exit 1
fi

if [[ ! $COMMIT_MSG =~ $COMMIT_PATTERN ]]; then
    echo -e "${RED}âŒ Invalid commit message format!${NC}"
    echo
    echo -e "${YELLOW}ğŸ“‹ Required format:${NC} ${BLUE}type: description${NC}"
    echo -e "${YELLOW}ğŸ“‹ Valid Examples:${NC}"
    echo -e "  ${GREEN}âœ… feat: add new authentication feature${NC}"
    echo -e "  ${GREEN}âœ… fix: resolve memory leak issue${NC}"
    echo -e "  ${GREEN}âœ… docs: update installation guide${NC}"
    echo -e "  ${GREEN}âœ… ci: update workflow configuration${NC}"
    echo
    echo -e "${YELLOW}ğŸš« Invalid examples:${NC}"
    echo -e "  ${RED}âŒ Add new feature${NC} (no type)"
    echo -e "  ${RED}âŒ FEAT: add feature${NC} (uppercase)"
    echo -e "  ${RED}âŒ feat:add feature${NC} (missing space after colon)"
    echo -e "  ${RED}âŒ feat(scope): add feature${NC} (scopes not allowed)"
    echo -e "  ${RED}âŒ ' fix: something'${NC} (leading whitespace)"
    echo
    exit 1
fi

# Extract type from commit message
COMMIT_TYPE=$(echo "$COMMIT_MSG" | sed -E 's/^([a-z]+)(\([^)]*\))?: .*/\1/')

# Check if type is valid
VALID_TYPE=false
for type in "${VALID_TYPES[@]}"; do
    if [[ "$COMMIT_TYPE" == "$type" ]]; then
        VALID_TYPE=true
        break
    fi
done

if [[ "$VALID_TYPE" == false ]]; then
    echo -e "${RED}âŒ Invalid commit type: ${COMMIT_TYPE}${NC}"
    echo
    echo -e "${YELLOW}ğŸ“‹ Valid types:${NC}"
    echo -e "  ${GREEN}âœ¨ feat${NC}      - new features"
    echo -e "  ${GREEN}ğŸ› fix${NC}       - bug fixes"
    echo -e "  ${GREEN}ğŸ“š docs${NC}      - documentation changes"
    echo -e "  ${GREEN}â™»ï¸  refactor${NC}  - code refactoring"
    echo -e "  ${GREEN}âš¡ perf${NC}      - performance improvements"
    echo -e "  ${GREEN}ğŸ§ª test${NC}      - adding or updating tests"
    echo -e "  ${GREEN}ğŸ› ï¸  build${NC}     - build system changes"
    echo -e "  ${GREEN}ğŸ”„ ci${NC}        - CI/CD changes"
    echo -e "  ${GREEN}ğŸ§¹ chore${NC}     - maintenance tasks"
    echo -e "  ${GREEN}ğŸ¨ style${NC}     - code style changes"
    echo -e "  ${GREEN}âª revert${NC}    - reverting previous commits"
    echo
    echo -e "${YELLOW}ğŸ’¡ Tip:${NC} Use ${BLUE}git commit --amend${NC} to fix your commit message"
    echo
    exit 1
fi

echo -e "${GREEN}âœ… Commit message validation passed!${NC}"
echo -e "${GREEN}ğŸ“ Type: ${COMMIT_TYPE}${NC}"

exit 0
