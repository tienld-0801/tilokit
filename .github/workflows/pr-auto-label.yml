name: üè∑Ô∏è Auto Label PR

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  auto-label:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.ref != 'main' && github.event.pull_request.head.ref != 'develop'
    
    steps:
      - name: Auto-label PR based on conventional commits
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = context.payload.pull_request.title;
            console.log(`üîç PR Title: "${title}"`);
            
            // Label mapping based on conventional commit types
            const labelMap = {
              'feat': 'enhancement',
              'fix': 'bug', 
              'perf': 'performance',
              'refactor': 'refactoring',
              'docs': 'documentation',
              'test': 'testing',
              'build': 'build',
              'ci': 'ci/cd',
              'chore': 'maintenance',
              'style': 'style',
              'revert': 'revert'
            };
            
            // Emoji mapping for title updates
            const emojiMap = {
              'feat': '‚ú®',
              'fix': 'üêõ',
              'perf': '‚ö°',
              'refactor': '‚ôªÔ∏è',
              'docs': 'üìö',
              'test': 'üß™',
              'build': 'üîß',
              'ci': 'üîÑ',
              'chore': 'üè†',
              'style': 'üíÑ',
              'revert': '‚è™'
            };
            
            // Check if title already has emoji
            const hasEmoji = /^[\u{1F300}-\u{1F9FF}]|^[\u{2600}-\u{26FF}]|^[\u{2700}-\u{27BF}]/u.test(title);
            
            // Extract type from conventional commit format
            const match = title.match(/^([a-z]+)(\([^)]+\))?:/);
            
            if (match) {
              const type = match[1];
              const label = labelMap[type];
              const emoji = emojiMap[type];
              
              console.log(`üîç Detected type: "${type}", Label: "${label}", Emoji: "${emoji}"`);
              
              if (label && emoji) {
                // 1. Update PR title with emoji if needed
                if (!hasEmoji) {
                  const newTitle = `${emoji} ${title}`;
                  
                  await github.rest.pulls.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: context.payload.pull_request.number,
                    title: newTitle
                  });
                  
                  console.log(`‚ú® Updated title: "${newTitle}"`);
                }
                
                // 2. Add label if not already present
                const currentLabels = context.payload.pull_request.labels.map(l => l.name);
                console.log(`üîç Current labels:`, currentLabels);
                
                if (!currentLabels.includes(label)) {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.payload.pull_request.number,
                    labels: [label]
                  });
                  
                  console.log(`‚úÖ Added label: ${label}`);
                } else {
                  console.log(`üîÑ Label "${label}" already exists`);
                }
                
                // 3. Comment about the auto-formatting
                const actions = [];
                if (!hasEmoji) actions.push('added emoji to title');
                if (!currentLabels.includes(label)) actions.push('added label');
                
                if (actions.length > 0) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.payload.pull_request.number,
                    body: `ü§ñ **Auto-formatted PR**\n\n` +
                          `**Type:** \`${type}\` ${emoji}\n` +
                          `**Label:** \`${label}\`\n` +
                          `**Actions:** ${actions.join(', ')}\n\n` +
                          `Thank you for following conventional commit standards! üöÄ`
                  });
                }
              } else {
                console.log(`‚ùì No label/emoji mapping found for type: ${type}`);
              }
            } else {
              console.log(`‚ùå Title doesn't follow conventional commit format`);
              
              // Comment with guidance
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `‚ùå **Invalid PR Title Format**\n\n` +
                      `Your PR title should follow conventional commit format:\n` +
                      `\`type(scope): description\`\n\n` +
                      `**Valid types:** feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert\n\n` +
                      `**Examples:**\n` +
                      `- \`feat: add new feature\`\n` +
                      `- \`fix(core): resolve critical bug\`\n` +
                      `- \`docs: update README\`\n\n` +
                      `Please update your PR title to follow this format for automatic labeling.`
              });
            }
