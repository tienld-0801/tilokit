name: ğŸ” Validate Commits

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-commits:
    runs-on: ubuntu-latest
    name: Validate Commit Messages
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for commit checking
          
      - name: ğŸ” Validate commit messages
        env:
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
        run: |
          echo "ğŸ” Validating commit messages..."
          chmod +x .husky/ci-check-commits.sh
          ./.husky/ci-check-commits.sh
          
      - name: ğŸ’¬ Comment on PR (if validation fails)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const message = `## âŒ Commit Validation Failed
            
            Your commits don't follow the conventional commit format. Please fix them before merging.
            
            ### ğŸ“‹ Required Format:
            \`type(scope): description\`
            
            ### âœ… Valid Types:
            - \`feat\`: new features
            - \`fix\`: bug fixes  
            - \`docs\`: documentation
            - \`refactor\`: code refactoring
            - \`perf\`: performance improvements
            - \`test\`: adding tests
            - \`build\`: build system changes
            - \`ci\`: CI/CD changes
            - \`chore\`: maintenance tasks
            - \`style\`: code style changes
            - \`revert\`: reverting changes
            
            ### ğŸ“ Examples:
            - \`feat: add user authentication\`
            - \`fix(core): resolve memory leak\`
            - \`docs: update API documentation\`
            - \`chore(deps): upgrade dependencies\`
            
            ### ğŸ”§ How to Fix:
            1. Use \`git rebase -i\` to edit commit messages
            2. Or squash commits with proper conventional format
            3. Force push the corrected commits
            
            For more details, check the [Conventional Commits](https://www.conventionalcommits.org) specification.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
            
      - name: âœ… Comment on PR (if validation passes) 
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const message = `## âœ… Commit Validation Passed
            
            All commits follow the conventional commit format! ğŸ‰
            
            Thank you for following our commit standards. This helps with:
            - ğŸ“ Automated changelog generation
            - ğŸ·ï¸ Automatic PR labeling  
            - ğŸš€ Better release notes
            - ğŸ“Š Project history tracking`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
