name: ğŸ” Validate Commits

on:
  # Only run on PRs - commits are already validated by pre-commit hooks
  # No need to re-validate when merging to develop
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-commits:
    runs-on: ubuntu-latest
    name: Validate Commit Messages

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for commit checking

      - name: ğŸ” Validate commit messages
        env:
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
        run: |
          echo "ğŸ” Validating commit messages..."
          chmod +x .husky/ci-check-commits.sh
          ./.husky/ci-check-commits.sh

      - name: ğŸ’¬ Comment on PR (if validation fails)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const message = `## âŒ Commit Validation Failed

            Your commits don't follow the **MANDATORY EMOJI** commit format. Please fix them before merging.

            ### ğŸ“‹ REQUIRED Format (Emoji is MANDATORY):
            \`emoji type: description\`

            ### âœ… Valid Types with Required Emojis:
            - \`âœ¨ feat\`: new features
            - \`ğŸ› fix\`: bug fixes
            - \`ğŸ“š docs\`: documentation
            - \`â™»ï¸ refactor\`: code refactoring
            - \`âš¡ perf\`: performance improvements
            - \`ğŸ§ª test\`: adding tests
            - \`ğŸ› ï¸ build\`: build system changes
            - \`ğŸ”„ ci\`: CI/CD changes
            - \`ğŸ§¹ chore\`: maintenance tasks
            - \`ğŸ¨ style\`: code style changes
            - \`âª revert\`: reverting changes
            - \`ğŸš€ release\`: version releases

            ### ğŸ“ Examples (Emoji REQUIRED):
            - \`âœ¨ feat: add user authentication\`
            - \`ğŸ› fix: resolve memory leak\`
            - \`ğŸ“š docs: update API documentation\`
            - \`ğŸ§¹ chore: upgrade dependencies\`

            ### âŒ Invalid Examples:
            - \`feat: add feature\` (missing emoji)
            - \`ğŸ› docs: update\` (wrong emoji for docs type)

            ### ğŸ”§ How to Fix:
            1. Use \`git rebase -i\` to edit commit messages
            2. Or squash commits with proper conventional format
            3. Force push the corrected commits

            For more details, check the [Conventional Commits](https://www.conventionalcommits.org) specification.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

      - name: âœ… Comment on PR (if validation passes)
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const message = `## âœ… Commit Validation Passed

            All commits follow the conventional commit format! ğŸ‰

            Thank you for following our commit standards. This helps with:
            - ğŸ“ Automated changelog generation
            - ğŸ·ï¸ Automatic PR labeling
            - ğŸš€ Better release notes
            - ğŸ“Š Project history tracking`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
